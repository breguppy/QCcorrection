---
title: "`r params$title %||% 'QC Correction Report'`"
output:
  html_document:
    self_contained: true
    toc: true
    toc_depth: 2
    toc_float: true
params:
  title:
    value: "QC Correction Report"
  notes:
    value: ""
  plots:
    value: !r character(0)
  choices:
    value: !r character(0)
  descriptions:
    value: !r character(0)
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(dev = "svg")
statement <- function(name) {
  d <- params$descriptions[[name]]
  if (is.character(d) && nzchar(d)) knitr::asis_output(paste0(d, "\n\n"))
}
library(htmltools)
library(dplyr)
library(QCcorrection)
```
# Preprocessing Steps

### Raw Data Basic Information
```{r}
QCcorrection:::ui_basic_info(params$choices$raw_df, params$choices$replacement_counts, params$choices$non_numerics_cols, params$choices$duplicate_mets, params$choices$high_corr_mets)
statement("Withheld Columns")
```

### Missing Value Filter
```{r}
QCcorrection:::ui_filter_info(params$choices$filtered$mv_removed_cols, params$choices$mv_cutoff, params$choices$filtered$qc_missing_mets)
```

### Missing Value Imputation
```{r}
statement("Imputation Description")
```

### Correction Description
```{r}
statement("Correction Description")
```

### Post-correction Filter
```{r}
QCcorrection:::ui_postcor_filter_info(params$choices$filtered_corrected, params$choices$rsd_cutoff, params$choices$post_cor_filter)
```

### Transformation Description
```{r}
statement("Transformation Description")
```

### Candidate Extreme Values
```{r}
statement("Candidate Extreme Values")
```

```{r}
QCcorrection:::ui_outliers(list(out_data = params$choices$out_data, qcImputeM = params$choices$qcImputeM, samImputeM = params$choices$samImputeM), list(filtered_corrected = params$choices$filtered_corrected, transformed = params$choices$transformed))
```

# Correction Evaluation

### Visualize the Correction with Metabolite Scatter Plots

```{r, echo=FALSE, fig.show='hold', out.width='49%', fig.width=5, fig.height=5}
print(params$plots[["Metabolite Scatter 1"]])
print(params$plots[["Metabolite Scatter 2"]])
```

```{r}
statement("Metabolite Scatter Plots")
```

### RSD Comparison

```{r, echo=FALSE, fig.width=7.5, fig.height=4.5}
print(params$plots[["RSD Comparison"]])
```

To judge how well the correction method worked, we can visualize the change in variation with the relative standard deviation (RSD) comparison plots. RSD is sometimes called coefficient of variation (CV) and is computed as RSD = (standard deviation / mean) * 100%. High RSD indicates that the values for that metabolite are more spread out around the mean, which may be an expected result in the experimental samples. For QC samples, RSD should decrease after correction.
```{r}
statement("RSD Comparison")
```

```{r}
QCcorrection:::ui_rsd_stats(list(rsd_compare = params$choices$rsd_compare, rsd_cal = params$choices$rsd_cal), list(filtered = params$choices$filtered, filtered_corrected = params$choices$filtered_corrected, transformed = params$choices$transformed))
```

### PCA Comparison

```{r, echo=FALSE, fig.width=8.333, fig.height=4.417}
print(params$plots[["PCA Comparison"]])
```

```{r}
statement("PCA Comparison")
```

```{r, echo=FALSE, fig.width=8.75, fig.height=4.417}
print(params$plots[["PCA Loading"]])
```

The loading values for the top 10 metabolites for each PC are plotted above. The magnitude of the loading corresponds to the metabolite's strength of correlation to that PC. A metabolite with a large magnitude (close to 1 or -1) has a strong influence/contribution to that PC and a metabolite with a small magnitude close to 0 has weak influence/contribution to that PC. A positive loading means that a high value in that metabolite corresponds to a high value in that PC. A negative loading means a high value in that metabolite corresponds to a low value in that PC.  
